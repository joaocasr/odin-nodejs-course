<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<title>Group Allocation</title>

<style>
  body { margin: 0; font-family: Arial, sans-serif; background-color: #2519ae87; }

  main{
    margin:10px;
  }
  nav {
      background-color: #1c2760; 
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 2rem;
  }
  nav .logo { font-size: 1rem; font-weight: bold; }
  .logoimg{
    display: block;
  }
  .ucllogo{
    margin: 10px;
  }
  nav ul { list-style: none; display: flex; gap: 1rem; margin: 0; padding: 0; }
  nav ul li a { color: white; text-decoration: none; font-weight: 500; }
  nav ul li a:hover { text-decoration: underline; }

  h1 {
    text-align: center;
    margin-bottom: 20px;
  }

  .top-controls {
    text-align: center;
    margin-bottom: 30px;
  }

  .groups-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
  }

  .group-card {
    background: #132c5a;
    border-radius: 10px;
    padding: 15px;
    color:white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  .group-card h2 {
    text-align: center;
    margin-bottom: 10px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
    font-size: 12px;
  }

  th, td {
    padding: 6px;
    border-bottom: 1px solid #2a4c8a;
    text-align: center;
  }

  th:first-child,
  td:first-child {
    text-align: left;
  }

  .add-team {
    display: flex;
    gap: 5px;
  }

  select {
    flex: 1;
    padding: 5px;
    border-radius: 5px;
    border: none;
  }

  button {
    background: #3d51b8;
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
  }

  button:hover {
    background: #171d57;
  }
  .navlink{
        background-color: #1e3a8a;
        border-radius: 4px;
        border: solid 1px white;
        padding: 10px;
  }
  .addgroupbtn{
    display: inline-flex;
    justify-content: center;
    align-content: center;
    width: 94%;
    margin-bottom: 10px;
  }
</style>

</head>

<nav>
    <div class="logoimg">
    <div class="logo">Champions League Inventory</div>
    <div>
      <img class="ucllogo" width="80px" height="80px" src="/logos/logo.png"/>
    </div>
    </div>
    <ul>
      <div class="navlink"><li><a href="/">Home</a></li></div>
    </ul>
</nav>

<body>

<h1>Allocate Teams to Groups</h1>
<main>
<div class="top-controls">
  <button onclick="createGroup()">+ Add Group</button>
</div>

<div class="groups-container" id="groupsContainer">
      <% if(groupsToUpdate){ %>
          <% Object.entries(groupsToUpdate).forEach(([groupName, teams]) => { %>

  <div class="group-card">
        <h2>Group <%= groupName %></h2>

        <form id="form-table-<%= teams[0].group_id %>" action="/add/group" method="POST">
    <table id="table-<%= teams[0].group_id %>">
      <thead>
        <tr>
          <th>Team</th>
          <th>MP</th>
          <th>W</th>
          <th>D</th>
          <th>L</th>
          <th>GF</th>
          <th>GA</th>
          <th>PTS</th>
        </tr>
       </thead> 
        <tbody>
                <% teams
                    .sort((a, b) => b.points - a.points)
                    .forEach((team, index) => { %>
        <tr>
            <td>
               <select id="select-<%= index %>">
                  <% allteams.forEach((select_team, index) => { %>
                          <% if(team.team_name == select_team.teamname){ %>
                            <option selected="selected" value="<%= select_team.teamid %>">
                              <%= select_team.teamname %>
                            </option>
                         <% } else { %>
                          <option value="<%= select_team.teamid %>">
                              <%= select_team.teamname %>
                            </option>
                         <% } %>
                    <% }) %>

              </select>
            </td>
            <td>
              <input
                type="number"
                min="0"
                value="<%= team.played %>"
                style="width:50px"
              >
            </td>
            <td>
              <input
                type="number"
                min="0"
                value="<%= team.wins %>"
                style="width:50px"
              >
            </td>
            <td>
              <input
                type="number"
                min="0"
                value="<%= team.draws %>"
                style="width:50px"
              >
            </td>
            <td>
              <input
                type="number"
                min="0"
                value="<%= team.losses %>"
                style="width:50px"
              >
            </td>
            <td>
              <input
                type="number"
                min="0"
                value="<%= team.goals_against %>"
                style="width:50px"
              >
            </td>
            <td>
              <input
                type="number"
                min="0"
                value="<%= team.points %>"
                style="width:50px"
              >
            </td>
        </tr>
          <% }) %>
        </tbody>
            <button class="addgroupbtn" type="submit">Update Group</button>

    </table>
            </form>
            <div class="add-team-select">
                  <select id="select-<%= teams[0].group_id %>">
                    getTeamOptions()
                  </select>
                  <button type="button" onclick="addTeam('<%= teams[0].group_id %>')">+</button>
            </div>
            <% }) %>
            <% } %>
  </div> 
</div>

<script>
const allTeams = <%- JSON.stringify(teams) %>;

let groupCounter = -1;
let groupNames = ['A','B','C','D','E','F','G','H'];
let assignedTeams = new Set();

// Stores stats per group
const groupData = {};

function createGroup() {
  if (groupCounter === 7) return;

  groupCounter++;
  const groupId = groupNames[groupCounter];

  groupData[groupId] = [];

  const card = document.createElement("div");
  card.className = "group-card";
  card.id = `group-${groupId}`;

  card.innerHTML = `
    <h2>Group ${groupId}</h2>

    <form id="form-table-${groupId}" action="/add/group" method="POST">
    <table id="table-${groupId}">
      <thead>
        <tr>
          <th>Team</th>
          <th>MP</th>
          <th>W</th>
          <th>D</th>
          <th>L</th>
          <th>GF</th>
          <th>GA</th>
          <th>PTS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="addgroupbtn" type="submit">Add Group</button>
    </form>

    <div class="add-team">
      <select id="select-${groupId}">
        ${getTeamOptions()}
      </select>
      <button type="button" onclick="addTeam('${groupId}')">+</button>
    </div>
  `;

  document.getElementById("groupsContainer").appendChild(card);
}

function getTeamOptions() {
  return allTeams
    .filter(team => !assignedTeams.has(team.teamid))
    .map(team => `
      <option value="${team.teamid}">
        ${team.teamname}
      </option>
    `)
    .join("");
}

async function addTeam(groupId) {
  const select = document.getElementById(`select-${groupId}`);
  if (!select.value) return;

  const teamId = Number(select.value);
  const teamName = select.options[select.selectedIndex].text;

  assignedTeams.add(teamId);

  // Create default stats object
  const teamStats = {
    id: teamId,
    name: teamName,
    mp: 0,
    w: 0,
    d: 0,
    l: 0,
    gf: 0,
    ga: 0,
    pts: 0
  };

  groupData[groupId].push(teamStats);

  // Add row to UI
  const table = document.querySelector(`#table-${groupId} tbody`);
  const row = document.createElement("tr");

  row.innerHTML = `
  <td>${teamName}</td>
  ${createStatInput(groupId, teamId, "seasonid")}
  ${createStatInput(groupId, teamId, "teamid")}
  ${createStatInput(groupId, teamId, "mp")}
  ${createStatInput(groupId, teamId, "w")}
  ${createStatInput(groupId, teamId, "d")}
  ${createStatInput(groupId, teamId, "l")}
  ${createStatInput(groupId, teamId, "gf")}
  ${createStatInput(groupId, teamId, "ga")}
  <td id="pts-${groupId}-${teamId}">0</td>
  `;
  table.appendChild(row);

  refreshDropdowns();
}

function refreshDropdowns() {
  document.querySelectorAll("select").forEach(select => {
    select.innerHTML = getTeamOptions();
  });
}

function createStatInput(groupId, teamId, stat) {
  if(stat=="teamid") return `
    <td style="width:0px;display: none;visibility: none;">
      <input
        type="hidden"
        value="${teamId}"
        name="group[${groupId}][${teamId}][${stat}]" 
        style="width:0px;display: none;visibility: none;">
    </td>
  `;
 if(stat=="seasonid") return `
    <td style="width:0px;display: none;visibility: none;">
      <input
        type="hidden"
        value="<%= seasonid %>"
        name="group[${groupId}][${teamId}][${stat}]" 
        style="width:0px;display: none;visibility: none;">
    </td>
  `;
  return `
    <td>
      <input
        type="number"
        min="0"
        value="0"
        name="group[${groupId}][${teamId}][${stat}]" 
        style="width:50px"
        onchange="updateStats('${groupId}', ${teamId}, '${stat}', this.value)"
      >
    </td>
  `;
}

function updateStats(groupId, teamId, stat, value) {
  const team = groupData[groupId].find(t => t.id === teamId);
  if (!team) return;

  team[stat] = Number(value);

  recalcTeam(groupId, teamId);
}

function recalcTeam(groupId, teamId) {
  const team = groupData[groupId].find(t => t.id === teamId);
  if (!team) return;

  const pts = team.w * 3 + team.d;

  team.pts = pts;

  document.getElementById(`pts-${groupId}-${teamId}`).innerText = pts;
}

</script>

</main>
</body>
</html>
